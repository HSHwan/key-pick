{% extends 'booking/base.html' %}

{% block title %}ì „ì²´ í†µê³„ ë¶„ì„ (Admin){% endblock %}

{% block content %}
<div class="admin-global-stats-dashboard">
    <h1>ğŸ“Š ì „ì²´ í†µê³„ ë¶„ì„ (Admin)</h1>
    <p class="text-muted" style="color: #666;">ì „ì²´ ì§€ì  ë° í…Œë§ˆì˜ ìš´ì˜ í˜„í™©ì„ í†µí•© ë¶„ì„í•©ë‹ˆë‹¤.</p>
    
    <hr style="margin-top: 20px; margin-bottom: 40px;">

    <div class="branch-sales-section">
        <h2>ğŸ¢ ì§€ì ë³„ ë§¤ì¶œ ìˆœìœ„</h2>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead style="background: #007bff; color: white;">
                <tr>
                    <th style="padding: 12px; text-align: center;">ìˆœìœ„</th>
                    <th style="padding: 12px; text-align: left;">ì§€ì ëª…</th>
                    <th style="padding: 12px; text-align: center;">ë³´ìœ  í…Œë§ˆ</th>
                    <th style="padding: 12px; text-align: center;">ì´ ì´ìš© ê±´ìˆ˜ (ì™„ë£Œ)</th>
                    <th style="padding: 12px; text-align: right;">ì´ ë§¤ì¶œì•¡</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in branch_stats %}
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px; text-align: center; font-weight: bold;">{{ forloop.counter }}</td>
                        <td style="padding: 12px;"><strong>{{ stat.branch_name }}</strong></td>
                        <td style="padding: 12px; text-align: center;">{{ stat.active_theme_count }}ê°œ</td>
                        <td style="padding: 12px; text-align: center;">{{ stat.total_reservations }}ê±´</td>
                        <td style="padding: 12px; text-align: right; font-weight: bold; color: #28a745;">
                            {{ stat.total_sales|default:"0"|floatformat:0 }}ì›
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" style="padding: 20px; text-align: center; color: #888;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <hr style="margin-top: 40px; margin-bottom: 40px;">

    <div class="theme-performance-section" style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h2 style="color: #28a745;">ğŸ”¥ ì¸ê¸° í…Œë§ˆ TOP 5 (ì˜ˆì•½ìˆœ)</h2>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead style="background: #28a745; color: white;">
                    <tr>
                        <th style="padding: 10px; text-align: center;">ìˆœìœ„</th>
                        <th style="padding: 10px; text-align: left;">í…Œë§ˆëª… (ì§€ì )</th>
                        <th style="padding: 10px; text-align: center;">ì´ìš© íšŸìˆ˜</th>
                        <th style="padding: 10px; text-align: center;">í‰ê·  ë³„ì </th>
                    </tr>
                </thead>
                <tbody>
                    {% for theme in best_themes %}
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px; text-align: center; font-weight: bold;">{{ forloop.counter }}</td>
                            <td style="padding: 10px;">
                                <strong>{{ theme.name }}</strong><br>
                                <small style="color: #888;">({{ theme.branch.branch_name }})</small>
                            </td>
                            <td style="padding: 10px; text-align: center; font-weight: bold; color: #007bff;">
                                {{ theme.res_count }}íšŒ
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                <span style="color: #ffc107;">â­ {{ theme.avg_score|default:"-"|floatformat:1 }}</span>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4" style="padding: 15px; text-align: center; color: #888;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="flex: 1;">
            <h2 style="color: #dc3545;">ğŸ“‰ ì˜ˆì•½ ì €ì¡° í…Œë§ˆ TOP 5</h2>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead style="background: #dc3545; color: white;">
                    <tr>
                        <th style="padding: 10px; text-align: center;">ìˆœìœ„</th>
                        <th style="padding: 10px; text-align: left;">í…Œë§ˆëª… (ì§€ì )</th>
                        <th style="padding: 10px; text-align: center;">ì´ìš© íšŸìˆ˜</th>
                    </tr>
                </thead>
                <tbody>
                    {% for theme in worst_themes %}
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px; text-align: center; font-weight: bold;">{{ forloop.counter }}</td>
                            <td style="padding: 10px;">
                                <strong>{{ theme.name }}</strong><br>
                                <small style="color: #888;">({{ theme.branch.branch_name }})</small>
                            </td>
                            <td style="padding: 10px; text-align: center; font-weight: bold; color: #6c757d;">
                                {{ theme.res_count }}íšŒ
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="3" style="padding: 15px; text-align: center; color: #888;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <hr style="margin-top: 40px; margin-bottom: 40px;">

    <div class="trend-chart-section">
        <h2>ğŸ“ˆ ìµœê·¼ 30ì¼ ìš´ì˜ ì¶”ì´ ({{ start_date|date:"Y.m.d" }} ~ {{ end_date|date:"Y.m.d" }})</h2>
        <div style="margin-top: 20px; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
            <canvas id="trendChart" height="100"></canvas>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const reservationData = [
        {% for item in daily_reservations %}
            { x: "{{ item.date|date:'Y-m-d' }}", y: {{ item.count }} },
        {% endfor %}
    ];
    
    const signupData = [
        {% for item in daily_signups %}
            { x: "{{ item.date|date:'Y-m-d' }}", y: {{ item.count }} },
        {% endfor %}
    ];

    // 2. ì°¨íŠ¸ ìƒì„±
    const ctx = document.getElementById('trendChart').getContext('2d');
    const trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'ì¼ë³„ ì˜ˆì•½ ê±´ìˆ˜',
                data: reservationData,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }, {
                label: 'ì¼ë³„ ì‹ ê·œ ê°€ì…',
                data: signupData,
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'category', // ë‚ ì§œì¶•
                    title: { display: true, text: 'ë‚ ì§œ' }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'ê±´ìˆ˜' }
                }
            }
        }
    });
</script>
{% endblock %}