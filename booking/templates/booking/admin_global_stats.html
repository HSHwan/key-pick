{% extends 'booking/base.html' %}

{% block title %}ì „ì²´ í†µê³„ ë¶„ì„ (Admin){% endblock %}

{% block content %}
<div class="container">
    <div class="mb-4">
        <h2 class="fw-bold mb-1">ğŸ“Š ì „ì²´ í†µê³„ ë¶„ì„ (Admin)</h2>
        <p class="text-muted">ì „ì²´ ì§€ì  ë° í…Œë§ˆì˜ ìš´ì˜ í˜„í™©ì„ í†µí•© ë¶„ì„í•©ë‹ˆë‹¤.</p>
    </div>

    <div class="content-box">
        <h4 class="fw-bold mb-3">ğŸ¢ ì§€ì ë³„ ë§¤ì¶œ ìˆœìœ„</h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-primary">
                    <tr>
                        <th class="text-center">ìˆœìœ„</th>
                        <th>ì§€ì ëª…</th>
                        <th class="text-center">ë³´ìœ  í…Œë§ˆ</th>
                        <th class="text-center">ì´ ì´ìš© ê±´ìˆ˜ (ì™„ë£Œ)</th>
                        <th class="text-end">ì´ ë§¤ì¶œì•¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in branch_stats %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td><strong>{{ stat.branch_name }}</strong></td>
                            <td class="text-center">{{ stat.active_theme_count }}ê°œ</td>
                            <td class="text-center">{{ stat.total_reservations }}ê±´</td>
                            <td class="text-end fw-bold text-success">
                                {{ stat.total_sales|default:"0"|floatformat:0 }}ì›
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="5" class="text-center py-3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="content-box h-100">
                <h4 class="fw-bold mb-3 text-success">ğŸ”¥ ì¸ê¸° í…Œë§ˆ TOP 5 <small class="text-muted fs-6">(ì˜ˆì•½ìˆœ)</small></h4>
                <table class="table table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">ìˆœìœ„</th>
                            <th>í…Œë§ˆëª… (ì§€ì )</th>
                            <th class="text-center">íšŸìˆ˜</th>
                            <th class="text-center">ë³„ì </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for theme in best_themes %}
                            <tr>
                                <td class="text-center fw-bold">{{ forloop.counter }}</td>
                                <td>
                                    <div class="fw-bold">{{ theme.name }}</div>
                                    <small class="text-muted">{{ theme.branch.branch_name }}</small>
                                </td>
                                <td class="text-center fw-bold text-primary">{{ theme.res_count }}íšŒ</td>
                                <td class="text-center text-warning">â­ {{ theme.avg_score|default:"-"|floatformat:1 }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4" class="text-center py-3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="content-box h-100">
                <h4 class="fw-bold mb-3 text-danger">ğŸ“‰ ì˜ˆì•½ ì €ì¡° í…Œë§ˆ TOP 5</h4>
                <table class="table table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">ìˆœìœ„</th>
                            <th>í…Œë§ˆëª… (ì§€ì )</th>
                            <th class="text-center">íšŸìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for theme in worst_themes %}
                            <tr>
                                <td class="text-center fw-bold">{{ forloop.counter }}</td>
                                <td>
                                    <div class="fw-bold">{{ theme.name }}</div>
                                    <small class="text-muted">{{ theme.branch.branch_name }}</small>
                                </td>
                                <td class="text-center fw-bold text-secondary">{{ theme.res_count }}íšŒ</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="3" class="text-center py-3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="content-box mt-4">
        <h4 class="fw-bold mb-3">ğŸ“ˆ ìµœê·¼ 30ì¼ ìš´ì˜ ì¶”ì´ <small class="text-muted fw-normal fs-6">({{ start_date|date:"Y.m.d" }} ~ {{ end_date|date:"Y.m.d" }})</small></h4>
        <div style="height: 300px; width: 100%;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

{{ daily_reservations|json_script:"dailyReservationsData" }}
{{ daily_signups|json_script:"dailySignupsData" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function getChartData(id) {
        // HTML ìš”ì†Œì— ìˆ¨ê²¨ì§„ JSON ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ íŒŒì‹±
        const element = document.getElementById(id);
        if (!element) {
            console.error('Data element not found:', id); // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ì¶œë ¥
            return [];
        }
        const rawData = JSON.parse(element.textContent);
        return rawData.map(item => ({
            x: item.date, 
            y: item.count 
        }));
    }
    
    // json_scriptì—ì„œ ì§€ì •í•œ ID("dailyReservationsData")ì™€ ì¼ì¹˜í•´ì•¼ í•¨
    const reservationData = getChartData('dailyReservationsData');
    const signupData = getChartData('dailySignupsData');
    
    const ctx = document.getElementById('trendChart').getContext('2d');
    const trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'ì¼ë³„ ì˜ˆì•½ ê±´ìˆ˜',
                data: reservationData,
                borderColor: '#4e54c8',
                backgroundColor: 'rgba(78, 84, 200, 0.1)',
                tension: 0.3,
                fill: true
            }, {
                label: 'ì¼ë³„ ì‹ ê·œ ê°€ì…',
                data: signupData,
                borderColor: '#ff6384',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                x: {
                    type: 'category',
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    grid: { borderDash: [5, 5] },
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
</script>
{% endblock %}