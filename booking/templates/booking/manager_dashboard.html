{% extends 'booking/base.html' %}

{% block title %}í…Œë§ˆ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="fw-bold mb-0">ğŸ“‹ í…Œë§ˆ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
            <p class="text-muted mt-1 mb-0">
                <strong>{{ user.name }}</strong>ë‹˜ ({{ user.get_role_display }}) | {{ today|date:"Yë…„ mì›” dì¼" }}
            </p>
        </div>
        <a href="{% url 'my-page' %}" class="btn btn-outline-secondary btn-sm">ë‚´ ì •ë³´ ë³´ê¸°</a>
    </div>

    <div class="row g-3 mb-4">
        <div class="col">
            <div class="content-box text-center p-3 h-100 d-flex flex-column justify-content-center">
                <h3 class="fw-bold mb-0">{{ stats.total }}</h3>
                <small class="text-muted">ì „ì²´ ì˜ˆì•½</small>
            </div>
        </div>
        <div class="col">
            <div class="content-box text-center p-3 h-100 d-flex flex-column justify-content-center border-start border-4 border-primary">
                <h3 class="fw-bold text-primary mb-0">{{ stats.confirmed }}</h3>
                <small class="text-muted">ì˜ˆì•½ í™•ì •</small>
            </div>
        </div>
        <div class="col">
            <div class="content-box text-center p-3 h-100 d-flex flex-column justify-content-center border-start border-4 border-success">
                <h3 class="fw-bold text-success mb-0">{{ stats.checked_in }}</h3>
                <small class="text-muted">ì…ì‹¤ ì™„ë£Œ</small>
            </div>
        </div>
        <div class="col">
            <div class="content-box text-center p-3 h-100 d-flex flex-column justify-content-center border-start border-4 border-secondary">
                <h3 class="fw-bold text-secondary mb-0">{{ stats.completed }}</h3>
                <small class="text-muted">ì´ìš© ì™„ë£Œ</small>
            </div>
        </div>
        <div class="col">
            <div class="content-box text-center p-3 h-100 d-flex flex-column justify-content-center border-start border-4 border-danger">
                <h3 class="fw-bold text-danger mb-0">{{ stats.cancelled }}</h3>
                <small class="text-muted">ì·¨ì†Œ</small>
            </div>
        </div>
    </div>
    
    <div class="content-box">
        <h4 class="fw-bold mb-3">ğŸ“… ì˜¤ëŠ˜ì˜ ì˜ˆì•½ ëª©ë¡</h4>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ì˜ˆì•½ ë²ˆí˜¸</th>
                        <th>ì‹œê°„</th>
                        <th>í…Œë§ˆ</th>
                        <th>ì§€ì </th>
                        <th>ì˜ˆì•½ì</th>
                        <th class="text-center">ì¸ì›</th>
                        <th class="text-center">ìƒíƒœ</th>
                        <th class="text-center">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reservation in reservations %}
                        <tr>
                            <td>#{{ reservation.reservation_id }}</td>
                            <td>{{ reservation.reservation_time|date:"H:i" }}</td>
                            <td><strong>{{ reservation.theme.name }}</strong></td>
                            <td>{{ reservation.theme.branch.branch_name }}</td>
                            <td>
                                {{ reservation.member.name|default:"íƒˆí‡´íšŒì›" }}
                            </td>
                            <td class="text-center">{{ reservation.num_of_participants }}ëª…</td>
                            <td class="text-center">
                                <span class="badge rounded-pill 
                                    {% if reservation.status == 'Confirmed' %}bg-primary
                                    {% elif reservation.status == 'CheckedIn' %}bg-success
                                    {% elif reservation.status == 'Completed' %}bg-secondary
                                    {% elif reservation.status == 'Cancelled' %}bg-danger
                                    {% else %}bg-warning text-dark{% endif %}">
                                    {{ reservation.get_status_display }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if reservation.status == 'Confirmed' %}
                                    <a href="{% url 'checkin-update' reservation.reservation_id %}" 
                                       class="btn btn-sm btn-success"
                                       onclick="return confirm('ì…ì‹¤ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì…ì‹¤</a>
                                    <a href="{% url 'noshow-update' reservation.reservation_id %}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('ë…¸ì‡¼ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ë…¸ì‡¼</a>
                                {% elif reservation.status == 'CheckedIn' %}
                                    <a href="{% url 'complete-reservation' reservation.reservation_id %}" 
                                       class="btn btn-sm btn-primary">ì™„ë£Œ ì²˜ë¦¬</a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">
                                ì˜¤ëŠ˜ ì˜ˆì •ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6">
            <div class="content-box h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold mb-0">ğŸš¨ ìµœê·¼ ë¬¸ì œ ë³´ê³  (ë¯¸í•´ê²°)</h4>
                    <a href="{% url 'issue-create' %}" class="btn btn-warning btn-sm fw-bold">
                        + ìƒˆ ë³´ê³ 
                    </a>
                </div>
                
                {% if recent_issues %}
                    <div class="list-group list-group-flush">
                        {% for issue in recent_issues %}
                            <div class="list-group-item px-0">
                                <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                    <div>
                                        <strong class="text-dark">{{ issue.theme.name }}</strong>
                                        <small class="text-muted">({{ issue.theme.branch.branch_name }})</small>
                                    </div>
                                    <span class="badge {% if issue.status == 'Reported' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                        {{ issue.get_status_display }}
                                    </span>
                                </div>
                                <p class="mb-1 text-secondary small">{{ issue.issue_description }}</p>
                                <small class="text-muted">
                                    {{ issue.reported_by_member.name|default:"ì‹œìŠ¤í…œ" }} | {{ issue.reported_at|date:"Y.m.d H:i" }}
                                </small>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4 text-muted">
                        í˜„ì¬ ë¯¸í•´ê²°ëœ ë¬¸ì œ ë³´ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                {% endif %}
                
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="fw-bold mb-2">ğŸ“ ê°„í¸ ë³´ê³  ë“±ë¡</h6>
                    <form method="POST">
                        {% csrf_token %}
                        <div class="mb-2">
                            {{ issue_form.theme }}
                        </div>
                        <div class="mb-2">
                            {{ issue_form.issue_description }}
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-warning btn-sm">ë³´ê³  ë“±ë¡</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="content-box h-100">
                <h4 class="fw-bold mb-3">ğŸ”‘ í…Œë§ˆ ìš´ì˜ ìƒíƒœ ê´€ë¦¬</h4>
                <div class="alert alert-info py-2 small mb-3">
                    <i class="bi bi-info-circle"></i> 'ì ê²€ ì¤‘' ìƒíƒœë¡œ ë³€ê²½í•˜ë©´ ê³ ê° ì˜ˆì•½ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.
                </div>
                
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ì§€ì /í…Œë§ˆ</th>
                                <th class="text-center">ìƒíƒœ</th>
                                <th class="text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for theme in themes %}
                                <tr>
                                    <td>
                                        <small class="text-muted d-block">{{ theme.branch.branch_name }}</small>
                                        <strong>{{ theme.name }}</strong>
                                    </td>
                                    <td class="text-center">
                                        {% if theme.status == 'Ready' %}
                                            <span class="badge bg-success">ìš´ì˜ ì¤‘</span>
                                        {% else %}
                                            <span class="badge bg-danger">ì ê²€ ì¤‘</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <form action="{% url 'theme-status-toggle' theme.theme_id %}" method="POST">
                                            {% csrf_token %}
                                            {% if theme.status == 'Ready' %}
                                                <button type="submit" onclick="return confirm('{{ theme.name }} ì˜ˆì•½ì„ ë§‰ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                                        class="btn btn-sm btn-outline-danger">
                                                    ì ê²€ ì „í™˜
                                                </button>
                                            {% else %}
                                                <button type="submit" onclick="return confirm('{{ theme.name }} ì˜ˆì•½ì„ ë‹¤ì‹œ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                                        class="btn btn-sm btn-outline-success">
                                                    ìš´ì˜ ì¬ê°œ
                                                </button>
                                            {% endif %}
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}