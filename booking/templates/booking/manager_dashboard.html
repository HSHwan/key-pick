{% extends 'booking/base.html' %}

{% block title %}í…Œë§ˆ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<div class="manager-dashboard">
    <h1>ğŸ“‹ í…Œë§ˆ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <p><strong>{{ user.name }}</strong>ë‹˜ ({{ user.get_role_display }})</p>
    <p>ì˜¤ëŠ˜ ë‚ ì§œ: {{ today|date:"Yë…„ mì›” dì¼" }}</p>
    
    <hr>

    <!-- ì˜¤ëŠ˜ì˜ ì˜ˆì•½ í˜„í™© í†µê³„ -->
    <div class="stats-section" style="background: #f4f4f4; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2>ğŸ“Š ì˜¤ëŠ˜ì˜ ì˜ˆì•½ í˜„í™©</h2>
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #333;">{{ stats.total }}</div>
                <div style="color: #888;">ì „ì²´ ì˜ˆì•½</div>
            </div>
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #007bff;">{{ stats.confirmed }}</div>
                <div style="color: #888;">ì˜ˆì•½ í™•ì •</div>
            </div>
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #28a745;">{{ stats.checked_in }}</div>
                <div style="color: #888;">ì…ì‹¤ ì™„ë£Œ</div>
            </div>
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #6c757d;">{{ stats.completed }}</div>
                <div style="color: #888;">ì´ìš© ì™„ë£Œ</div>
            </div>
            <div class="stat-card" style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #dc3545;">{{ stats.cancelled }}</div>
                <div style="color: #888;">ì·¨ì†Œ</div>
            </div>
        </div>
    </div>
    
    <hr>
    
    <!-- ì˜¤ëŠ˜ì˜ ì˜ˆì•½ ëª©ë¡ -->
    <div class="reservation-list-section">
        <h2>ğŸ“… ì˜¤ëŠ˜ì˜ ì˜ˆì•½ ëª©ë¡</h2>
        
        {% if reservations %}
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead style="background: #333; color: white;">
                    <tr>
                        <th style="padding: 10px; text-align: left;">ì˜ˆì•½ ë²ˆí˜¸</th>
                        <th style="padding: 10px; text-align: left;">ì‹œê°„</th>
                        <th style="padding: 10px; text-align: left;">í…Œë§ˆ</th>
                        <th style="padding: 10px; text-align: left;">ì§€ì </th>
                        <th style="padding: 10px; text-align: left;">ì˜ˆì•½ì</th>
                        <th style="padding: 10px; text-align: center;">ì¸ì›</th>
                        <th style="padding: 10px; text-align: center;">ìƒíƒœ</th>
                        <th style="padding: 10px; text-align: center;">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reservation in reservations %}
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">{{ reservation.reservation_id }}</td>
                            <td style="padding: 10px;">{{ reservation.reservation_time|date:"H:i" }}</td>
                            <td style="padding: 10px;"><strong>{{ reservation.theme.name }}</strong></td>
                            <td style="padding: 10px;">{{ reservation.theme.branch.branch_name }}</td>
                            <td style="padding: 10px;">{{ reservation.member.name|default:"íƒˆí‡´íšŒì›" }}</td>
                            <td style="padding: 10px; text-align: center;">{{ reservation.num_of_participants }}ëª…</td>
                            <td style="padding: 10px; text-align: center;">
                                {% if reservation.status == 'Confirmed' %}
                                    <span style="color: #007bff; font-weight: bold;">â— {{ reservation.get_status_display }}</span>
                                {% elif reservation.status == 'CheckedIn' %}
                                    <span style="color: #28a745; font-weight: bold;">â— {{ reservation.get_status_display }}</span>
                                {% elif reservation.status == 'Completed' %}
                                    <span style="color: #6c757d; font-weight: bold;">â— {{ reservation.get_status_display }}</span>
                                {% elif reservation.status == 'Cancelled' %}
                                    <span style="color: #dc3545; font-weight: bold;">â— {{ reservation.get_status_display }}</span>
                                {% else %}
                                    <span style="color: #ffc107; font-weight: bold;">â— {{ reservation.get_status_display }}</span>
                                {% endif %}
                            </td>
                            <td style="padding: 10px; text-align: center;">
                                {% if reservation.status == 'Confirmed' %}
                                    <a href="{% url 'checkin-update' reservation.reservation_id %}" 
                                       style="background: #28a745; color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.9em;" onclick="return confirm('ì…ì‹¤ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"></a>
                                        ì…ì‹¤ í™•ì¸
                                    </a>
                                    <a href="{% url 'noshow-update' reservation.reservation_id %}" class="btn-sm"
                                    style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.9em;" onclick="return confirm('ë…¸ì‡¼ ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ë…¸ì‡¼</a>
                                {% elif reservation.status == 'CheckedIn' %}
                                    <a href="{% url 'complete-reservation' reservation.reservation_id %}" 
                                       style="background: #007bff; color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 0.9em;">
                                        ì™„ë£Œ
                                    </a>
                                {% else %}
                                    <span style="color: #888;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="margin-top: 20px; color: #888;">ì˜¤ëŠ˜ ì˜ˆì•½ëœ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>
    
    <hr style="margin-top: 40px;">
    
    <!-- ìµœê·¼ ë¬¸ì œ ë³´ê³  -->
    <div class="issue-report-section">
        <h2>ğŸš¨ ìµœê·¼ ë¬¸ì œ ë³´ê³  (ë¯¸í•´ê²°)</h2>
        <a href="{% url 'issue-create' %}" class="btn" style="background: #ffc107; padding: 8px 15px; border-radius: 4px; text-decoration: none; color: black; font-weight: bold;">
            + ìƒˆ ë¬¸ì œ ë³´ê³ 
        </a>
        {% if recent_issues %}
            <div style="margin-top: 20px;">
                {% for issue in recent_issues %}
                    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 1.1em;">{{ issue.theme.name }}</strong>
                                <span style="color: #888; font-size: 0.9em;">({{ issue.theme.branch.branch_name }})</span>
                            </div>
                            <div>
                                {% if issue.status == 'Reported' %}
                                    <span style="color: #dc3545; font-weight: bold;">â— ë³´ê³ ë¨</span>
                                {% elif issue.status == 'InProgress' %}
                                    <span style="color: #ffc107; font-weight: bold;">â— ì²˜ë¦¬ ì¤‘</span>
                                {% endif %}
                            </div>
                        </div>
                        <p style="margin: 10px 0; color: #555;">{{ issue.issue_description }}</p>
                        <div style="font-size: 0.9em; color: #888;">
                            ë³´ê³ ì: {{ issue.reported_by_member.name|default:"ì‹œìŠ¤í…œ" }} | 
                            ë³´ê³  ì‹œê°„: {{ issue.reported_at|date:"Y.m.d H:i" }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="margin-top: 20px; color: #888;">ë¯¸í•´ê²° ë¬¸ì œ ë³´ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>

    <div class="issue-report-form-section" style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3>ğŸ“ ì‹œì„¤ ë¬¸ì œ ë³´ê³ í•˜ê¸°</h3>
        <form method="POST">
            {% csrf_token %}
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    {{ issue_form.theme.label_tag }}
                    {{ issue_form.theme }}
                </div>
            </div>
            <div style="margin-bottom: 10px;">
                {{ issue_form.issue_description.label_tag }}
                {{ issue_form.issue_description }}
            </div>
            <button type="submit" style="background: #ffc107; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px;">ë³´ê³  ë“±ë¡</button>
        </form>
    </div>
    
    <div class="theme-management-section">
        <h2>ğŸ”‘ í…Œë§ˆ ìš´ì˜ ìƒíƒœ ê´€ë¦¬</h2>
        <p style="color: #666; font-size: 0.9em;">'ì ê²€ ì¤‘' ìƒíƒœë¡œ ë³€ê²½í•˜ë©´ ê³ ê°ì´ ì˜ˆì•½ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <thead style="background: #333; color: white;">
                <tr>
                    <th style="padding: 12px; text-align: left;">ì§€ì </th>
                    <th style="padding: 12px; text-align: left;">í…Œë§ˆëª…</th>
                    <th style="padding: 12px; text-align: center;">í˜„ì¬ ìƒíƒœ</th>
                    <th style="padding: 12px; text-align: center;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for theme in themes %}
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px;">{{ theme.branch.branch_name }}</td>
                        <td style="padding: 12px;"><strong>{{ theme.name }}</strong></td>
                        <td style="padding: 12px; text-align: center;">
                            {% if theme.status == 'Ready' %}
                                <span style="color: #28a745; font-weight: bold; background: #e6f9e6; padding: 5px 10px; border-radius: 20px; font-size: 0.9em;">
                                    â— ìš´ì˜ ê°€ëŠ¥
                                </span>
                            {% else %}
                                <span style="color: #dc3545; font-weight: bold; background: #ffe6e6; padding: 5px 10px; border-radius: 20px; font-size: 0.9em;">
                                    â— ì ê²€ ì¤‘
                                </span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <form action="{% url 'theme-status-toggle' theme.theme_id %}" method="POST">
                                {% csrf_token %}
                                {% if theme.status == 'Ready' %}
                                    <button type="submit" onclick="return confirm('{{ theme.name }} ì˜ˆì•½ì„ ë§‰ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                            style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                        ì ê²€ ì „í™˜ (ì˜ˆì•½ ë§‰ê¸°)
                                    </button>
                                {% else %}
                                    <button type="submit" onclick="return confirm('{{ theme.name }} ì˜ˆì•½ì„ ë‹¤ì‹œ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                            style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                        ìš´ì˜ ì¬ê°œ (ì˜ˆì•½ ì—´ê¸°)
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}